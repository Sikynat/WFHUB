{% extends 'base.html' %}
{% block title %}Gerar Pedido Manual{% endblock %}

{% block content %}
    <h1>Gerar Pedido Manual</h1>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Passo 1: Selecione o Cliente</h5>
            <form method="get" class="d-flex align-items-end">
                {{ form_cliente.cliente }}
                <button type="submit" class="btn btn-primary ms-2">Selecionar</button>
            </form>
        </div>
    </div>

    {% if cliente_selecionado %}
        <p>
            Cliente selecionado: <strong>{{ cliente_selecionado.client_name }}</strong>
            (Código: {{ cliente_selecionado.client_code }})
        </p>

        <h2>Produtos para Pedido</h2>

        <form action="" method="get" class="mb-3">
            <div class="input-group">
                <input type="hidden" name="cliente" value="{{ cliente_selecionado.client_id }}">

                <input type="text" name="codigo" placeholder="Código" class="form-control" value="{{ request.GET.codigo }}">
                <input type="text" name="descricao" placeholder="Descrição" class="form-control" value="{{ request.GET.descricao }}">
                <input type="text" name="grupo" placeholder="Grupo" class="form-control" value="{{ request.GET.grupo }}">
                <input type="text" name="marca" placeholder="Marca" class="form-control" value="{{ request.GET.marca }}">
                <button type="submit" class="btn btn-success">Filtrar</button>
                <a href="?cliente={{ cliente_selecionado.client_id }}" class="btn btn-warning">Limpar Filtro</a>
            </div>
        </form>

        <hr>
        
        <form id="gerar-pedido-form" action="{% url 'gerar_pedido' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="cliente_id" value="{{ cliente_selecionado.client_id }}">
            <input type="hidden" name="cart_data" id="cart-data-input">

            <div class="table-responsive">
                 <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Código do Produto</th>
                            <th>Descrição do Produto</th>
                            <th>Grupo</th>
                            <th>Marca</th>
                            <th>Valor ({{ preco_exibido|upper }})</th>
                            <th>Quantidade</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in product_list %}
                        <tr>
                            <td>{{ product.product_code }}</td>
                            <td>{{ product.product_description }}</td>
                            <td>{{ product.product_group }}</td>
                            <td>{{ product.product_brand }}</td>
                            {% if preco_exibido == 'sp' %}
                                <td class="product-value" data-value="{{ product.product_value_sp }}">{{ product.valor_sp_formatado }}</td>
                            {% elif preco_exibido == 'es' %}
                                <td class="product-value" data-value="{{ product.product_value_es }}">{{ product.valor_es_formatado }}</td>
                            {% endif %}
                            <td>
                                <input
                                    type="number"
                                    name="quantidade_{{ product.product_id }}"
                                    id="quantidade_{{ product.product_id }}"
                                    min="0"
                                    class="form-control sm input-quantidade">
                            </td>
                            <td>
                                <span id="total_{{ product.product_id }}">R$ 0,00</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7">Nenhum produto cadastrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="text-end"><strong>Total Geral:</strong></td>
                            <td><strong id="grand-total">R$ 0,00</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <button type="submit" class="btn btn-primary">Gerar Pedido</button>
            <a href="#" class="btn btn-warning" onclick="limparCache()">Limpar Carrinho</a>
        </form>

        {% if product_list.has_other_pages %}
    <nav aria-label="Navegação da página">
        <ul class="pagination justify-content-center">
            
            {% if product_list.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{{ query_params.urlencode }}&page=1">Primeira</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{{ query_params.urlencode }}&page={{ product_list.previous_page_number }}">Anterior</a>
                </li>
            {% endif %}

            {% for i in product_list.paginator.page_range %}
                {% if product_list.number == i %}
                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                {% elif i > product_list.number|add:'-3' and i < product_list.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?{{ query_params.urlencode }}&page={{ i }}">{{ i }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if product_list.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{{ query_params.urlencode }}&page={{ product_list.next_page_number }}">Próxima</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{{ query_params.urlencode }}&page={{ product_list.paginator.num_pages }}">Última</a>
                </li>
            {% endif %}

        </ul>
    </nav>
{% endif %}
    {% else %}
        <p>Por favor, selecione um cliente para começar a gerar um pedido.</p>
    {% endif %}

{% endblock %}