{% extends 'base.html' %}
{% block title %}Gerar Pedido Manual{% endblock %}

{% block content %}
    <h1>Gerar Pedido Manual</h1>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Passo 1: Selecione o Cliente</h5>
            <form method="get" class="d-flex align-items-end">
                {{ form_cliente.cliente }}
                <button type="submit" class="btn btn-primary ms-2">Selecionar</button>
            </form>
        </div>
    </div>

    {% if cliente_selecionado %}
        <p>
            Cliente selecionado: <strong>{{ cliente_selecionado.client_name }}</strong>
            (Código: {{ cliente_selecionado.client_code }})
        </p>

        <h2>Produtos para Pedido</h2>

        <form action="" method="get" class="mb-3">
             <div class="input-group">
                <input type="hidden" name="cliente" value="{{ cliente_selecionado.client_id }}">
                <input type="text" name="codigo" placeholder="Código" class="form-control" value="{{ request.GET.codigo }}">
                <input type="text" name="descricao" placeholder="Descrição" class="form-control" value="{{ request.GET.descricao }}">
                <input type="text" name="grupo" placeholder="Grupo" class="form-control" value="{{ request.GET.grupo }}">
                <input type="text" name="marca" placeholder="Marca" class="form-control" value="{{ request.GET.marca }}">
                <button type="submit" class="btn btn-success">Filtrar</button>
                <a href="?cliente={{ cliente_selecionado.client_id }}" class="btn btn-warning">Limpar Filtro</a>
            </div>
        </form>

        <hr>
        
        <form id="gerar-pedido-form" action="{% url 'processar_pedido_manual' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="cliente_id" value="{{ cliente_selecionado.client_id }}">
            <input type="hidden" name="cart_data" id="cart-data-input">

            <div class="card mb-4 mt-4">
                <div class="card-body">
                    <h5 class="card-title">Detalhes de Envio</h5>
                    <div class="mb-3">
                        <label for="endereco_selecionado" class="form-label">Endereço de Entrega:</label>
                        <select id="endereco_selecionado" name="endereco_selecionado" class="form-control" required>
                            {% if enderecos %}
                                <option value="">Selecione um endereço</option>
                                {% for endereco in enderecos %}
                                    <option value="{{ endereco.id }}">{{ endereco.logradouro }}, {{ endereco.numero }} - {{ endereco.cidade }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">Nenhum endereço cadastrado para este cliente.</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="data_envio" class="form-label">Data de Envio Solicitada:</label>
                        <input type="date" id="data_envio" name="data_envio" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="frete_option" class="form-label">Opção de Frete:</label>
                        <select id="frete_option" name="frete_option" class="form-control" required>
                            <option value="">Selecione uma opção de frete</option>
                            <option value="SEDEX">Sedex</option>
                            <option value="CORREIOS">Correios</option>
                            <option value="ONIBUS">Ônibus</option>
                            <option value="TRANSPORTADORA">Transportadora</option>
                            <option value="RETIRADA">Retirada</option>  </select>
                        </select>
                    </div>

                    <div class="mb-3">
                    <label for="nota_fiscal" class="form-label">Opção de Nota Fiscal:</label>
                    <select id="nota_fiscal" name="nota_fiscal" class="form-control" required>
                        <option value="">Selecione uma opção</option>
                        <option value="COM">Com Nota Fiscal</option>
                        <option value="SEM">Sem Nota Fiscal</option>
                    </select>
                </div>

                </div>
            </div>

            <div class="table-responsive">
                 <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Código do Produto</th>
                            <th>Descrição do Produto</th>
                            <th>Grupo</th>
                            <th>Marca</th>
                            <th>Valor ({{ preco_exibido|upper }})</th>
                            <th>Quantidade</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in product_list %}
                        <tr>
                            <td>{{ product.product_code }}</td>
                            <td>{{ product.product_description }}</td>
                            <td>{{ product.product_group }}</td>
                            <td>{{ product.product_brand }}</td>
                            {% if preco_exibido == 'sp' %}
                                <td class="product-value" data-value="{{ product.product_value_sp }}">{{ product.valor_sp_formatado }}</td>
                            {% elif preco_exibido == 'es' %}
                                <td class="product-value" data-value="{{ product.product_value_es }}">{{ product.valor_es_formatado }}</td>
                            {% endif %}
                            <td>
                                <input
                                    type="number"
                                    name="quantidade_{{ product.product_id }}"
                                    id="quantidade_{{ product.product_id }}"
                                    min="0"
                                    class="form-control sm input-quantidade">
                            </td>
                            <td>
                                <span id="total_{{ product.product_id }}">R$ 0,00</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7">Nenhum produto cadastrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="text-end"><strong>Total Geral:</strong></td>
                            <td><strong id="grand-total">R$ 0,00</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <button type="submit" class="btn btn-primary">Gerar Pedido</button>
            <a href="#" class="btn btn-warning" onclick="limparCache()">Limpar Carrinho</a>
        </form>

        {% if product_list.has_other_pages %}
    <nav aria-label="Navegação da página">
        <ul class="pagination justify-content-center">
            
            {% if product_list.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{{ query_params.urlencode }}&page=1">Primeira</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{{ query_params.urlencode }}&page={{ product_list.previous_page_number }}">Anterior</a>
                </li>
            {% endif %}

            {% for i in product_list.paginator.page_range %}
                {% if product_list.number == i %}
                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                {% elif i > product_list.number|add:'-3' and i < product_list.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?{{ query_params.urlencode }}&page={{ i }}">{{ i }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if product_list.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{{ query_params.urlencode }}&page={{ product_list.next_page_number }}">Próxima</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{{ query_params.urlencode }}&page={{ product_list.paginator.num_pages }}">Última</a>
                </li>
            {% endif %}

        </ul>
    </nav>
{% endif %}
    {% else %}
        <p>Por favor, selecione um cliente para começar a gerar um pedido.</p>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const quantidadeInputs = document.querySelectorAll('input[type="number"][name^="quantidade_"]');
            const grandTotalElement = document.getElementById('grand-total');

            const messagesContainer = document.querySelector('.mt-3');
            const successMessage = messagesContainer ? messagesContainer.querySelector('.alert-success') : null;

            if (successMessage) {
                localStorage.clear();
            } else {
                loadAndCalculateTotals();
            }

            // --- NOVO CÓDIGO MAIS SEGURO PARA PRÉ-SELECIONAR AS PREFERÊNCIAS DO CLIENTE ---
            const freteSelect = document.getElementById('frete_option');
            const notaFiscalSelect = document.getElementById('nota_fiscal');
            const enderecoSelect = document.getElementById('endereco_selecionado'); // Adicione esta linha

            // Verifica se o cliente está selecionado e pré-seleciona as opções
            {% if cliente_selecionado %}
                {% if cliente_selecionado.frete_preferencia %}
                    freteSelect.value = "{{ cliente_selecionado.frete_preferencia }}";
                {% endif %}
                {% if cliente_selecionado.nota_fiscal_preferencia %}
                    notaFiscalSelect.value = "{{ cliente_selecionado.nota_fiscal_preferencia }}";
                {% endif %}
                // NOVO CÓDIGO AQUI
                {% if initial_data.endereco_padrao_id %}
                    if (enderecoSelect) {
                        enderecoSelect.value = "{{ initial_data.endereco_padrao_id }}";
                    }
                {% endif %}
            {% endif %}
            // --- FIM DO NOVO CÓDIGO ---

            // Nova função para coletar os dados do localStorage e preencher o campo hidden
            document.getElementById('gerar-pedido-form').addEventListener('submit', function(e) {
                const cartData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('quantidade_')) {
                        const savedItem = localStorage.getItem(key);
                        if (savedItem) {
                            try {
                                const itemData = JSON.parse(savedItem);
                                if (itemData.quantidade > 0) {
                                    cartData[key.split('_')[1]] = itemData.quantidade;
                                }
                            } catch (error) {
                                console.error('Erro ao processar item do localStorage:', error);
                            }
                        }
                    }
                }
                document.getElementById('cart-data-input').value = JSON.stringify(cartData);
            });


            function loadAndCalculateTotals() {
                quantidadeInputs.forEach(input => {
                    const savedItem = localStorage.getItem(input.id);
                    if (savedItem) {
                        try {
                            const itemData = JSON.parse(savedItem);
                            if (itemData && itemData.quantidade > 0) {
                                input.value = itemData.quantidade;
                            } else {
                                input.value = 0;
                            }
                        } catch (e) {
                            input.value = 0;
                        }
                    }
                    updateTotals(input);
                });
            }

            function updateTotals(inputElement) {
                const row = inputElement.closest('tr');
                const valorUnitarioElement = row.querySelector('.product-value');

                if (!valorUnitarioElement) {
                    return;
                }
                
                const valorUnitario = parseFloat(valorUnitarioElement.dataset.value.replace(',', '.'));
                const quantidade = parseFloat(inputElement.value);

                if (!isNaN(valorUnitario) && !isNaN(quantidade)) {
                    const total = valorUnitario * quantidade;
                    row.querySelector(`span#total_${inputElement.id.split('_')[1]}`).innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
                }

                updateGrandTotal();
            }

            function updateGrandTotal() {
                let totalGeral = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('quantidade_')) {
                        const savedItem = localStorage.getItem(key);
                        if (savedItem) {
                            try {
                                const itemData = JSON.parse(savedItem);
                                if (!isNaN(itemData.valor) && !isNaN(itemData.quantidade)) {
                                    totalGeral += itemData.valor * itemData.quantidade;
                                }
                            } catch (e) {
                                // Ignora itens mal formatados
                            }
                        }
                    }
                }
                grandTotalElement.innerText = `R$ ${totalGeral.toFixed(2).replace('.', ',')}`;
            }

            quantidadeInputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const row = e.target.closest('tr');
                    const valorUnitarioElement = row.querySelector('.product-value');
                    const valorUnitario = parseFloat(valorUnitarioElement.dataset.value.replace(',', '.'));
                    
                    const itemData = {
                        quantidade: parseFloat(e.target.value),
                        valor: valorUnitario
                    };
                    localStorage.setItem(e.target.id, JSON.stringify(itemData));
                    
                    updateTotals(e.target);
                });
            });
        });
        
        function limparCache() {
            localStorage.clear();
            location.reload();
        }
    </script>
{% endblock %}