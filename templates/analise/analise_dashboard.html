{% extends "base.html" %}
{% load carrinho_extras %} 
{% load static %}
{% load humanize %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">{{ titulo }}</h2>

    <div class="card mb-4">
        <div class="card-header">
            Filtro por Per√≠odo
        </div>
        <div class="card-body">
            <form method="GET" class="form-inline mb-2">
                <div class="form-group mr-3">
                    <label for="data_inicio" class="mr-2">In√≠cio:</label>
                    <input type="date" id="data_inicio" name="data_inicio" class="form-control" value="{{ data_inicio }}">
                </div>
                <div class="form-group mr-3">
                    <label for="data_fim" class="mr-2">Fim:</label>
                    <input type="date" id="data_fim" name="data_fim" class="form-control" value="{{ data_fim }}">
                </div>
                <button type="submit" class="btn btn-primary mr-2">Aplicar Filtro</button>
                
                <a href="{% url 'analise_dados_dashboard' %}?periodo_geral=true" class="btn btn-secondary">
                    Todo o Hist√≥rico
                </a>
            </form>
            
            <p class="mt-3">
                Per√≠odo Selecionado: 
                
                {% if data_inicio and data_fim %}
                    <strong>{{ data_inicio }}</strong> at√© 
                    <strong>{{ data_fim }}</strong>
                {% else %}
                    <span class="text-muted">Padr√£o ou Nenhuma Data Definida</span>
                {% endif %}

                {% if periodo_geral_ativo %}
                    <span class="badge badge-warning ml-2">Modo Hist√≥rico Total</span>
                {% endif %}
            </p>
        </div>
    </div>
    
    <div class="alert alert-warning mb-4">
        <strong class="text-dark">DIAGN√ìSTICO (Remover ap√≥s valida√ß√£o):</strong> O valor total de **TODOS** os pedidos no banco √©: 
        <strong>R$ {{ total_historico_teste|floatformat:2|intcomma }}</strong>
    </div>
    
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Vendas SP (Clientes)</h5>
                    <p class="card-text h3">
                        R$ {{ total_vendas_sp_clientes|floatformat:2|intcomma }}
                    </p>
                    <small>Soma de Pedidos de Clientes em SP</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Vendas ES (Clientes)</h5>
                    <p class="card-text h3">
                        R$ {{ total_vendas_es_clientes|floatformat:2|intcomma }}
                    </p>
                    <small>Soma de Pedidos de Clientes em ES</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">TOTAL GERAL FILTRADO</h5>
                    <p class="card-text h3">
                        R$ {{ total_vendas_periodo_calculado|floatformat:2|intcomma }}
                    </p>
                    <small>Soma de TODOS os estados no per√≠odo.</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total de Itens Vendidos</h5>
                    <p class="card-text h3">N/A</p>
                    <small>Contagem total de itens vendidos.</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    üèÜ Top 5 Clientes por Valor de Compra (SP)
                </div>
                <ul class="list-group list-group-flush">
                    {% for cliente in clientes_top_sp %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ forloop.counter }}. {{ cliente.nome|default:"N/A" }}</strong> 
                            <small class="text-muted">({{ cliente.codigo|default:"N/A" }})</small>
                        </div>
                        <span class="badge badge-primary badge-pill">
                            R$ {{ cliente.total_gasto|floatformat:2|intcomma }}
                        </span>
                    </li>
                    {% empty %}
                    <li class="list-group-item">Nenhum cliente de SP encontrado no per√≠odo.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    üèÜ Top 5 Clientes por Valor de Compra (ES)
                </div>
                <ul class="list-group list-group-flush">
                    {% for cliente in clientes_top_es %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ forloop.counter }}. {{ cliente.nome|default:"N/A" }}</strong> 
                            <small class="text-muted">({{ cliente.codigo|default:"N/A" }})</small>
                        </div>
                        <span class="badge badge-info badge-pill">
                            R$ {{ cliente.total_gasto|floatformat:2|intcomma }}
                        </span>
                    </li>
                    {% empty %}
                    <li class="list-group-item">Nenhum cliente de ES encontrado no per√≠odo.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    üìà Vendas por M√™s no Per√≠odo
                </div>
                <div class="card-body">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>M√™s/Ano</th>
                                <th>Total Vendido (Est. SP)</th>
                                <th>Total Vendido (Est. ES)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venda in vendas_por_mes %}
                            <tr>
                                <td>{{ venda.mes_ano|date:"F/Y" }}</td>
                                <td>R$ {{ venda.total_vendas|floatformat:2|intcomma }}</td>
                                <td>R$ {{ venda.total_vendas_es|floatformat:2|intcomma }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3">Nenhum dado de venda por m√™s no per√≠odo.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    ‚è≥ √öltimas Compras de Clientes
                </div>
                <ul class="list-group list-group-flush">
                    {% for cliente in clientes_com_ultima_compra %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ cliente.client_name }}</strong> 
                            <small class="text-muted">({{ cliente.client_code }})</small>
                        </div>
                        <span class="badge badge-info badge-pill">√öltima compra: {{ cliente.data_ultima_compra|date:"d/m/Y" }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item">Nenhum cliente com pedidos encontrados.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos b√°sicos para o template */
    .badge-primary { background-color: #007bff; }
    .badge-secondary { background-color: #6c757d; }
    .badge-info { background-color: #17a2b8; }
    .badge-warning { background-color: #ffc107; color: #343a40; }
    .card-header { font-weight: bold; }
    .bg-success { background-color: #28a745 !important; }
    .bg-info { background-color: #17a2b8 !important; }
    .bg-dark { background-color: #343a40 !important; }
    .bg-primary { background-color: #007bff !important; } 
    .bg-secondary { background-color: #6c757d !important; }
    .alert-warning { background-color: #fff3cd; border-color: #ffeeba; color: #856404; }
</style>

{% endblock %}