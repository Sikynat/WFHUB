{% extends 'base.html' %}
{% block title %}Pedido #{{ pedido.id }} - Detalhes{% endblock %}

{% block content %}
    <h1 class="display-5 fw-bold text-dark mb-4">
        Detalhes do Pedido <span class="text-secondary fw-light">#{{ pedido.id }}</span>
    </h1>

    <div class="row mb-5">
        
        {# Card: Informações Essenciais #}
        <div class="col-lg-6 mb-4">
            <div class="card h-100 border-0 shadow-sm rounded-lg">
                <div class="card-body p-4">
                    <h5 class="card-title fw-bold text-primary mb-3">Informações Principais</h5>
                    
                    <div class="row g-2 mb-4">
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Data da Compra:</small>
                            <p class="fw-medium mb-0">{{ pedido.data_criacao|date:"d/m/Y H:i" }}</p>
                        </div>
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Situação:</small>
                            <span class="badge rounded-pill fs-6 bg-{% if pedido.status == 'FINALIZADO' %}success{% elif is_atrasado %}danger{% else %}info{% endif %}">{{ pedido.status }}</span>
                        </div>
                    </div>

                    <div class="row g-2 mb-4">
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Expedição Solicitada:</small>
                            <p class="fw-medium mb-0">{{ pedido.data_envio_solicitada|date:"d/m/Y" }}</p>
                        </div>
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Cliente:</small>
                            <p class="fw-medium mb-0">{{ pedido.cliente.client_code }}</p>
                        </div>
                    </div>
                    
                    <small class="text-muted d-block">Observação:</small>
                    <p class="fst-italic text-wrap mb-4">{{ pedido.observacao|default:"Nenhuma." }}</p>

                    <div class="row g-2">
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Opção de Frete:</small>
                            <p class="fw-medium mb-0">{{ pedido.get_frete_option_display }}</p>
                        </div>
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Opção de NF:</small>
                            <p class="fw-medium mb-0">{{ pedido.get_nota_fiscal_display }}</p>
                        </div>
                    </div>
                    
                    {% if user.is_staff %}
                        <hr class="my-3">
                        <small class="text-muted d-block">Criado por:</small>
                        <p class="fw-medium mb-0">{{ pedido.criado_por.username }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        {# Card de Endereço e Orçamento PDF #}
        <div class="col-lg-6 d-flex flex-column">
            {% if pedido.frete_option != 'ONIBUS' and pedido.frete_option != 'RETIRADA' %}
                <div class="card h-100 border-0 shadow-sm rounded-lg mb-4">
                    <div class="card-body p-4">
                        <h5 class="card-title fw-bold text-info mb-3">Endereço de Envio</h5>
                        <p class="mb-0 fw-medium">{{ pedido.endereco.logradouro }}, {{ pedido.endereco.numero }} - {{ pedido.endereco.bairro }}</p>
                        <p class="text-muted">{{ pedido.endereco.cidade }} - {{ pedido.endereco.estado }} (CEP: {{ pedido.endereco.cep }})</p>
                    </div>
                </div>
            {% endif %}

            {% if pedido.orcamento_pdf %}
                <div class="card border-0 shadow-sm rounded-lg">
                    <div class="card-body d-flex justify-content-between align-items-center p-4">
                        <h6 class="mb-0 fw-bold">Orçamento PDF Anexado</h6>
                        <a href="{{ pedido.orcamento_pdf.url }}" target="_blank" class="btn btn-outline-primary btn-sm rounded-pill ms-3">
                            <i class="bi bi-file-earmark-pdf"></i> Visualizar
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    
    <hr class="my-5">

    {# Seção de Ações #}
    <h2 class="h5 fw-bold text-dark mb-4">Gerenciamento do Pedido</h2>
    <div class="d-flex flex-wrap gap-3 p-4 border rounded-lg bg-light mb-5">
        {# Ações Comuns de Exportação #}
        <a href="{% url 'pedidos' %}" class="btn btn-outline-secondary rounded-pill">
            <i class="bi bi-arrow-left me-1"></i> Voltar
        </a>
        
        {% if user.is_staff %}
            <a href="{% url 'dashboard_admin' %}" class="btn btn-outline-secondary rounded-pill">
                <i class="bi bi-speedometer2 me-1"></i> Dashboard
            </a>
            <a href="{% url 'exportar_detalhes_pedido_admin_excel' pedido.id %}" class="btn btn-outline-info rounded-pill">
                <i class="bi bi-file-earmark-excel me-1"></i> Exportar (Admin)
            </a>
        {% else %}
            <a href="{% url 'exportar_pedido_cliente_excel' pedido.id %}" class="btn btn-outline-info rounded-pill">
                <i class="bi bi-file-earmark-excel me-1"></i> Exportar
            </a>
        {% endif %}

        {# Ações de Staff e Controle #}
        {% if user.is_staff %}
            <a  href="{% url 'enviar_whatsapp' pedido.id %}" target="_blank" class="btn btn-success rounded-pill">
                <i class="bi bi-whatsapp me-1"></i> Enviar Whatsapp
            </a>

            {% if is_atrasado %}
                <form action="{% url 'marcar_pedido_finalizado' pedido.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger rounded-pill fw-bold">
                        <i class="bi bi-check-circle me-1"></i> Marcar como Finalizado
                    </button>
                </form>
            {% endif %}

            {# Upload de Orçamento com Collapse #}
            <button class="btn btn-outline-primary rounded-pill" type="button" data-bs-toggle="collapse" data-bs-target="#collapseForm" aria-expanded="false" aria-controls="collapseForm">
                <i class="bi bi-cloud-arrow-up me-1"></i> Upload Orçamento
            </button>
            <div class="collapse w-100 mt-3" id="collapseForm">
                <div class="p-3 border rounded-lg bg-white">
                    <form action="{% url 'upload_orcamento_pdf' pedido.id %}" method="post" enctype="multipart/form-data" class="d-flex gap-2">
                        {% csrf_token %}
                        <input type="file" name="orcamento_pdf_file" class="form-control form-control-sm rounded-pill" required>
                        <button class="btn btn-primary rounded-pill" type="submit">Enviar</button>
                    </form>
                </div>
            </div>
        {% endif %}
    </div>
    
    <hr class="my-5">
    
    {# Tabela de Itens #}
    <h2 class="h5 fw-bold text-dark mb-4">Itens do Pedido</h2>
    <div class="table-responsive shadow-sm rounded-lg">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th scope="col" class="text-uppercase small text-muted border-bottom-0 ps-4">Código</th>
                    <th scope="col" class="text-uppercase small text-muted border-bottom-0">Descrição</th>
                    {% if preco_exibido == 'sp' %}
                        <th scope="col" class="text-end text-uppercase small text-muted border-bottom-0">Valor (SP)</th>
                    {% elif preco_exibido == 'es' %}
                        <th scope="col" class="text-end text-uppercase small text-muted border-bottom-0">Valor (ES)</th>
                    {% elif preco_exibido == 'todos' %}
                        <th scope="col" class="text-end text-uppercase small text-muted border-bottom-0">Valor (SP)</th>
                        <th scope="col" class="text-end text-uppercase small text-muted border-bottom-0">Valor (ES)</th>
                    {% endif %}
                    <th scope="col" class="text-end text-uppercase small text-muted border-bottom-0">Quantidade</th>
                    <th scope="col" class="text-end text-uppercase small text-muted border-bottom-0 pe-4">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for item_detalhe in itens_detalhes %}
                <tr class="border-bottom">
                    <td class="fw-bold ps-4">{{ item_detalhe.item.produto.product_code }}</td>
                    <td>{{ item_detalhe.item.produto.product_description }}</td>
                    {% if preco_exibido == 'todos' %}
                        <td class="text-end text-muted">R$ {{ item_detalhe.item.produto.product_value_sp|floatformat:2 }}</td>
                        <td class="text-end text-muted">R$ {{ item_detalhe.item.produto.product_value_es|floatformat:2 }}</td>
                    {% else %}
                        <td class="text-end text-muted">R$ {{ item_detalhe.valor_unitario|floatformat:2 }}</td>
                    {% endif %}
                    <td class="text-end">{{ item_detalhe.item.quantidade }}</td>
                    <td class="text-end text-primary fw-bold pe-4">R$ {{ item_detalhe.valor_total|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    {% if preco_exibido == 'todos' %}
                        <td colspan="5" class="text-end fw-bold fs-6 pt-3 ps-4">Total Geral:</td>
                    {% else %}
                        <td colspan="4" class="text-end fw-bold fs-6 pt-3 ps-4">Total Geral:</td>
                    {% endif %}
                    <td class="text-end fw-bold fs-4 text-success pt-3 pe-4">R$ {{ total_geral|floatformat:2 }}</td>
                </tr>
            </tfoot>
        </table>
    </div>
{% endblock %}